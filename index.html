<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemari AI â€” Join</title>
  <link rel="stylesheet" href="style.css"/>
  <!-- Firebase v10 (modular) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <main class="container">
    <h1>Hemari AI ðŸ’–</h1>
    <p class="sub">Your AI girlfriend</p>

    <p class="small">Have a code from an affiliate? Enter it below.</p>
    <div class="form">
      <input id="refInput" class="input" maxlength="6" inputmode="numeric"
             placeholder="Enter 6-digit referral code" />
      <button id="joinBtn" class="btn">Continue with Google</button>
    </div>

    <button class="btn secondary" id="goAffiliate">Sign in / Sign up as Affiliate</button>
    <footer>Â© 2025 Hemari AI. All rights reserved.</footer>
  </main>

  <script>
    // ----  Firebase config  ----
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "hemari.firebaseapp.com",
      projectId: "hemari",
      storageBucket: "hemari.firebasestorage.app",
      messagingSenderId: "1050131542351",
      appId: "1:1050131542351:web:629e977e097ea4d291953a",
      measurementId: "G-73WF2B7X79"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Fill input if ?ref=XXXXXX is present
    const urlParams = new URLSearchParams(location.search);
    const refFromUrl = (urlParams.get('ref')||'').toUpperCase();
    const refInput = document.getElementById('refInput');
    if(refFromUrl && /^\w{6}$/.test(refFromUrl)) refInput.value = refFromUrl;

    // Simple 6-char alnum validator (digits allowed). If you want strictly digits: /^\d{6}$/
    const isValidCode = c => /^\w{6}$/.test((c||'').trim());

    // Continue with Google: create user (if first time), and attribute referral
    const TELEGRAM_URL = "https://t.me/cute_hemari_bot";

    document.getElementById('joinBtn').addEventListener('click', async () => {
      const code = refInput.value.trim().toUpperCase();
      if(!isValidCode(code)){ alert("Please enter a valid 6-digit code."); return; }

      // Save locally (handy for later)
      localStorage.setItem('hemari_ref', code);

      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const { user, additionalUserInfo } = await auth.signInWithPopup(provider);

        // 1) Ensure users collection has this user
        const uref = db.collection('users').doc(user.uid);
        const usnap = await uref.get();

        // 2) On first signup only, increment affiliate's userCount if affiliate exists
        if(!usnap.exists){
          // try to find affiliate by referralCode
          const q = await db.collection('affiliates').where('referralCode', '==', code).limit(1).get();
          if(!q.empty){
            const affDoc = q.docs[0].ref;
            await db.runTransaction(async (tx)=>{
              const a = await tx.get(affDoc);
              const curr = a.data().userCount || 0;
              tx.update(affDoc, { userCount: curr + 1 });
            });
          }
          // add user record
          await uref.set({
            email: user.email,
            name: user.displayName || "",
            referredBy: code,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // 3) Redirect to Telegram bot
        location.href = TELEGRAM_URL;

      }catch(err){
        console.error(err);
        // Fallback to redirect flow on popup blockers
        try{
          await auth.signInWithRedirect(provider);
        }catch(e){ alert("Sign-in failed. Please try again."); }
      }
    });

    document.getElementById('goAffiliate').addEventListener('click', ()=>{
      location.href = 'affiliate.html';
    });
  </script>
</body>
</html>

